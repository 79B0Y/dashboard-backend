# ğŸ“˜ Dashboard Backend å®‰è£…ä¸æ¥å£è°ƒè¯•è¯´æ˜

æ›´æ–°æ—¶é—´ï¼š2025-05-26

---

## ğŸš€ å¿«é€Ÿå®‰è£…éƒ¨ç½²

### ç¯å¢ƒä¾èµ–

* Node.js 18+
* Docker (ç”¨äºè¿è¡Œ MongoDB)

### ä¸€é”®éƒ¨ç½²æ­¥éª¤

```bash
# è§£å‹é¡¹ç›®å‹ç¼©åŒ…
unzip dashboard-backend-with-install.zip
cd dashboard-backend

# å¯é€‰ï¼šèµ‹äºˆæ‰§è¡Œæƒé™
chmod +x install.sh

# æ‰§è¡Œå®‰è£…è„šæœ¬
./install.sh
```

è¯¥è„šæœ¬å°†è‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

* å®‰è£… Node ä¾èµ–ï¼ˆ`npm install`ï¼‰
* è‡ªåŠ¨å¤åˆ¶ `.env.example` ä¸º `.env`
* å¯åŠ¨æœ¬åœ° MongoDB å®¹å™¨ï¼ˆå¦‚æœªè¿è¡Œï¼‰
* å¯åŠ¨åç«¯æœåŠ¡ï¼ˆé»˜è®¤ç«¯å£ï¼š3001ï¼‰

---

## ğŸ”§ æ‰‹åŠ¨è¿è¡Œï¼ˆå¼€å‘æ¨¡å¼ï¼‰

```bash
# å¯åŠ¨ Mongo å®¹å™¨
MONGO_PORT=27017 docker run -d \
  --name dashboard-mongo \
  -p 27017:27017 \
  -v dashboard_mongo_data:/data/db \
  mongo:6

# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨æœåŠ¡
npm start
```

è®¿é—®æ¥å£ï¼š`http://localhost:3001`

---

## ğŸ” API Key æˆæƒè¯´æ˜

æ‰€æœ‰ API è¯·æ±‚éƒ½å¿…é¡»å¸¦ä¸Šåˆæ³•çš„ `API Key`ï¼Œæ”¯æŒä»¥ä¸‹ä¸¤ç§æ–¹å¼ä¹‹ä¸€ï¼š

* è¯·æ±‚å¤´ï¼š`X-API-Key: your-api-key`
* URL å‚æ•°ï¼š`?key=your-api-key`

---
# ğŸ“˜ Dashboard åç«¯æ¥å£æ–‡æ¡£ï¼ˆå®Œæ•´ - Markdown å¢å¼ºç‰ˆï¼‰

> ğŸ•’ æ›´æ–°æ—¶é—´ï¼š2025-05-26

---

## ğŸŒ æ¥å£åŸºç¡€ä¿¡æ¯

- **æœåŠ¡åœ°å€**ï¼ˆå¼€å‘ï¼‰ï¼š`http://localhost:3001`
- **é‰´æƒæ–¹å¼**ï¼šé™¤éƒ¨åˆ†æ¥å£å¤–ï¼Œæ‰€æœ‰æ¥å£éƒ½å¿…é¡»æºå¸¦ API Keyï¼š
  - è¯·æ±‚å¤´æ–¹å¼ï¼š`X-API-Key: your-key`
  - æˆ– URL å‚æ•°æ–¹å¼ï¼š`?key=your-key`

---

## ğŸ“‘ æ¥å£æ€»è§ˆ

| æ¥å£è·¯å¾„              | æ–¹æ³• | æè¿°                        | é‰´æƒ | å¤‡æ³¨                                     |
|------------------------|------|-----------------------------|------|------------------------------------------|
| `/api/apikey`         | POST | æ ¹æ®ç”¨æˆ· ID åˆ›å»º API Key     | å¦   | ä»…é¦–æ¬¡ç»‘å®šï¼Œæ— éœ€æ—§ key                   |
| `/api/apikey`         | GET  | æ ¹æ®ç”¨æˆ· ID æŸ¥è¯¢ API Key     | å¦   | æŸ¥è¯¢æ˜¯å¦å·²ç»‘å®šï¼Œè¿”å›å·²ç”Ÿæˆçš„ key         |
| `/api/config`         | GET  | è·å–ä»ªè¡¨ç›˜é…ç½®               | âœ…   | è¿”å›å½“å‰é…ç½® JSON                        |
| `/api/config`         | PUT  | æ›´æ–°ä»ªè¡¨ç›˜é…ç½®               | âœ…   | æ›´æ–° layout å†…å®¹                         |
| `/api/config/agg`     | POST | æŸ¥è¯¢æŒ‡å®šå¡ç‰‡çš„æ•°æ®ï¼ˆèšåˆï¼‰   | âœ…   | èšåˆæŸ¥è¯¢ï¼ˆcollection + pipelineï¼‰        |

---

## ğŸ—ƒ MongoDB æ•°æ®ç»“æ„è¯´æ˜

### âœ… é›†åˆï¼šapikeys
```json
{
  "userId": "user_001",
  "key": "uuid-xxxx",
  "createdAt": "2025-05-26T10:00:00Z"
}
```

### âœ… é›†åˆï¼šconfigs
```json
{
  "userId": "user_001",
  "layout": {
    "cards": [
      {
        "title": "æ€»èƒ½è€—",
        "type": "kpi",                  // å¯é€‰ç±»å‹ï¼škpi, line, bar, heatmap, html
        "collection": "device_stats",
        "pipeline": [ ... ],
        "position": { "x": 0, "y": 0 },
        "size": { "w": 3, "h": 2 }
      }
    ]
  },
  "versions": [],
  "createdAt": "...",
  "updatedAt": "..."
}
```

### âœ… é›†åˆï¼šdevice_statsï¼ˆç¤ºä¾‹æ•°æ®ï¼‰
```json
{
  "user": "user_001",
  "device": "AC",
  "energy": 1.85,
  "ts": "2025-05-25T08:00:00Z",
  "date": "2025-05-25"
}
```

ğŸ“ æ¯æ¡è®°å½•ä¸ºè®¾å¤‡åœ¨æŸæ—¶æ®µçš„èƒ½è€—å€¼ï¼Œä¾›èšåˆç»Ÿè®¡ä½¿ç”¨ã€‚

---

## ğŸ” åˆ›å»º API Key

**æ¥å£åœ°å€**ï¼š`POST /api/apikey`

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```json
{
  "userId": "user_123"
}
```

**è¿”å›ï¼ˆæ–°å»ºï¼‰**ï¼š
```json
{
  "key": "xxx-xxx-uuid"
}
```

**è¿”å›ï¼ˆå·²å­˜åœ¨ï¼‰**ï¼š
```json
{
  "error": "API key already exists for this user",
  "key": "xxx-xxx-existing"
}
```

---

## ğŸ” æŸ¥è¯¢ API Key

**æ¥å£åœ°å€**ï¼š`GET /api/apikey?userId=user_123`

- å‚æ•°è¯´æ˜ï¼š`userId` ä¸ºç”¨æˆ·å”¯ä¸€ ID

**è¿”å›ï¼ˆå­˜åœ¨ï¼‰**ï¼š
```json
{
  "key": "xxx-xxx-uuid"
}
```

**è¿”å›ï¼ˆæœªç»‘å®šï¼‰**ï¼š
```json
{
  "error": "API key not found for this user"
}
```

ğŸ“ ä¸éœ€è¦é‰´æƒï¼Œå‰ç«¯å¯ç”¨ä½œæ³¨å†Œé€»è¾‘åˆ¤æ–­æ˜¯å¦å·²æœ‰ keyã€‚

---

## ğŸ“¥ è·å–ä»ªè¡¨ç›˜é…ç½®

**æ¥å£åœ°å€**ï¼š`GET /api/config?key=xxx`

**è¿”å›ç¤ºä¾‹**ï¼š
```json
{
  "userId": "user_123",
  "layout": {
    "cards": [
      {
        "title": "æ€»èƒ½è€—",
        "type": "kpi",
        "collection": "device_stats",
        "pipeline": [...],
        "position": { "x": 0, "y": 0 },
        "size": { "w": 3, "h": 2 }
      }
    ]
  },
  "versions": [...]
}
```

ğŸ“ `position` è¡¨ç¤ºå¡ç‰‡åœ¨ä»ªè¡¨ç›˜ä¸Šçš„ä½ç½®ï¼ˆä»¥æ …æ ¼ä¸ºå•ä½ï¼‰ï¼›`size` æ”¯æŒæ¨ªçºµå‘ä»»æ„å€æ•°æ‰©å±•ï¼Œå¦‚ `w=4, h=3` è¡¨ç¤ºå®½åº¦ 4 å•ä½ï¼Œé«˜åº¦ 3 å•ä½ã€‚

---

## ğŸ“¤ æ›´æ–°ä»ªè¡¨ç›˜é…ç½®

**æ¥å£åœ°å€**ï¼š`PUT /api/config?key=xxx`

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```json
{
  "layout": {
    "cards": [
      {
        "title": "æ—¥ç”¨ç”µè¶‹åŠ¿",
        "type": "line",
        "collection": "device_stats",
        "pipeline": [...],
        "position": { "x": 0, "y": 1 },
        "size": { "w": 6, "h": 2 }
      }
    ]
  }
}
```

**è¿”å›ç¤ºä¾‹**ï¼š
```json
{
  "ok": true,
  "config": { ...updated... }
}
```

ğŸ“ `type` å­—æ®µæ”¯æŒå¤šç§å›¾è¡¨ç±»å‹ï¼Œå¦‚ `kpi`ã€`line`ã€`bar`ã€`heatmap` ç­‰ï¼›å‰ç«¯å¯æ ¹æ® `size` è¿›è¡Œé€‚é…æ¸²æŸ“ã€‚

---

## ğŸ“Š èšåˆæŸ¥è¯¢å¡ç‰‡æ•°æ®

**æ¥å£åœ°å€**ï¼š`POST /api/config/agg?key=xxx`

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```json
{
  "collection": "device_stats",
  "pipeline": [
    { "$match": { "device": "abc123" } },
    { "$group": { "_id": null, "total": { "$sum": "$power" } } }
  ]
}
```

**è¿”å›ç¤ºä¾‹**ï¼š
```json
{
  "value": {
    "total": 285.7
  }
}
```

ğŸ“ æ”¯æŒä»»æ„èšåˆé€»è¾‘ï¼Œç”±å‰ç«¯æ ¹æ®å¡ç‰‡å®šä¹‰åŠ¨æ€æ„é€  pipelineã€‚

---

## ğŸ“¡ WebSocket æ¨é€ï¼ˆå¯é€‰ï¼‰

- **è¿æ¥åœ°å€**ï¼š`ws://localhost:3001`
- **è¿æ¥æˆåŠŸåå°†æ”¶åˆ°æ¬¢è¿åŒ…**ï¼š
```json
{
  "type": "welcome",
  "ts": 1748200000
}
```

- **é…ç½®æ›´æ–°åæœåŠ¡å°†å¹¿æ’­äº‹ä»¶**ï¼š
```json
{
  "type": "configUpdated",
  "userId": "user_123",
  "ts": 1748201234
}
```

- **å•ä¸ªå¡ç‰‡æ•°æ®æ›´æ–°åæœåŠ¡ä¹Ÿå°†æ¨é€äº‹ä»¶**ï¼š
```json
{
  "type": "cardUpdated",
  "userId": "user_123",
  "cardTitle": "æ€»èƒ½è€—",
  "value": { "total": 285.7 },
  "ts": 1748204567
}
```

ğŸ“ å‰ç«¯å¯ç›‘å¬ `configUpdated` äº‹ä»¶ç”¨äºæ•´ä½“é…ç½®åˆ·æ–°ï¼Œç›‘å¬ `cardUpdated` äº‹ä»¶ç”¨äºå®æ—¶æ›´æ–°å•å¼ å¡ç‰‡å†…å®¹ï¼ˆå¦‚ KPI æ•°å€¼ç­‰ï¼‰
```

ğŸ“ å‰ç«¯å¯ç›‘å¬è¯¥äº‹ä»¶åé‡æ–°æ‹‰å– `/api/config?key=xxx`ï¼Œå®ç°é…ç½®çƒ­æ›´æ–°æ•ˆæœã€‚

ğŸ“ æœªæ¥å¯æ¨é€ `configUpdated` ç­‰äº‹ä»¶å®ç°å®æ—¶çƒ­æ›´æ–°ã€‚

---

å¦‚éœ€æ‰©å±•åŠŸèƒ½ï¼ˆå¦‚å›¾è¡¨èšåˆæœåŠ¡ã€ç”¨æˆ·è§’è‰²æƒé™ã€Token é‰´æƒç­‰ï¼‰ï¼Œè¯·æå‰å®šä¹‰å­—æ®µç»“æ„ä¸è®¿é—®è§„åˆ™ï¼Œåç«¯å¯å¿«é€Ÿé€‚é…ã€‚



