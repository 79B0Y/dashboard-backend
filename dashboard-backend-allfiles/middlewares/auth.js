// middlewares/auth.js â€“ APIâ€‘Key é‰´æƒä¸­é—´ä»¶
// -------------------------------------------------------
// â–¶ ä½¿ç”¨æ–¹å¼ï¼š`app.use(authMiddleware)` â†’ æ‰€æœ‰åç»­è·¯ç”±ç»Ÿä¸€é‰´æƒ
// â–¶ é€»è¾‘ï¼š
//    1. å°è¯•ä»è¯·æ±‚å¤´ `X-API-Key` è¯»å– key
//    2. è‹¥ä¸å­˜åœ¨ï¼Œå†æ£€æŸ¥æŸ¥è¯¢å‚æ•° `?key=`
//    3. æ ¡éªŒå¤±è´¥è¿”å› 401ï¼›æˆåŠŸåˆ™æŠŠ key ä½œä¸º userId æ³¨å…¥ `req.apiKey`
// -------------------------------------------------------

export const authMiddleware = (req, res, next) => {
  // â‘  æ”¯æŒä¸¤ç§å†™æ³•ï¼šHeader ä¼˜å…ˆï¼Œå…¶æ¬¡ URL å‚æ•°
  const key = req.headers['x-api-key'] || req.query.key;

  if (!key) {
    return res.status(401).json({ error: 'API key required' });
  }

  // â‘¡ å¯åœ¨æ­¤å¤„éªŒè¯ key æ˜¯å¦å­˜åœ¨äºæ•°æ®åº“
  //    ä¾‹å¦‚ä½¿ç”¨ ApiKey.findOne({ key }) â†’ 404 æ—¶è¿”å› 401
  //    ä¸ºç®€åŒ–ç¤ºä¾‹ï¼Œæ­¤å¤„ç›´æ¥ä¿¡ä»»ä¼ å…¥ keyã€‚

  req.apiKey = key;          // åç»­æ§åˆ¶å™¨å¯è§†ä¸º userId / tenantId
  next();                    // â‘¢ è¿›å…¥ä¸‹ä¸€ä¸­é—´ä»¶ / è·¯ç”±
};

/*
ğŸ’¡ æ‰©å±•æ€è·¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- è‹¥è¦åš **æƒé™è§’è‰²**ï¼šå¯åœ¨æŸ¥åº“å `req.user = { id, roles: [...] }`
- è‹¥è¦åš **é€Ÿç‡é™åˆ¶**ï¼šå¯ç»“åˆ express-rate-limit æŒ‰ key é™æµã€‚
- è‹¥è¦åš **è¿‡æœŸæ—¶é—´**ï¼šåœ¨ ApiKey æ¨¡å‹åŠ  `expiresAt` å­—æ®µå¹¶æ ¡éªŒã€‚
*/
